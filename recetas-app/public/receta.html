<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receta Médica - Dr. Miranda</title>
    <link rel="stylesheet" href="receta.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
            <p>Cargando receta...</p>
        </div>
    </div>

    <div id="errorScreen" class="error-screen" style="display: none;">
        <div class="error-content">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                    fill="#ef4444" />
            </svg>
            <h2>Receta no encontrada</h2>
            <p>El código de receta no es válido o ha expirado.</p>
            <p class="error-code" id="errorCode"></p>
        </div>
    </div>

    <div id="recetaContainer" class="receta-container" style="display: none;">
        <div class="no-print actions-bar">
            <button onclick="window.print()" class="btn btn-primary">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"
                        fill="currentColor" />
                </svg>
                Imprimir
            </button>
        </div>

        <div class="receta-page">
            <!-- Header -->
            <header class="receta-header">
                <div class="header-left">
                    <div class="logo">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="35" r="15" fill="#1e3a5f" />
                            <path
                                d="M 35 45 Q 35 55 40 65 L 40 85 Q 40 90 45 90 L 55 90 Q 60 90 60 85 L 60 65 Q 65 55 65 45 Z"
                                fill="#1e3a5f" />
                            <circle cx="50" cy="70" r="8" fill="#c9a961" opacity="0.8" />
                        </svg>
                    </div>
                    <div class="doctor-info">
                        <h1>Dr. Manuel Andrés Miranda Guillermo</h1>
                        <p>Ginecología y Obstetricia</p>
                        <p>Centro de Colposcopía de Mérida</p>
                    </div>
                </div>
                <div class="header-right">
                    <p><strong>Cédula Profesional:</strong> 12159299</p>
                    <p><strong>Cédula de Especialidad:</strong> 14893137</p>
                    <p><strong>Código de Receta:</strong> <code id="recetaCodigo"></code></p>
                </div>
            </header>

            <div class="receta-divider"></div>

            <!-- Información del Paciente -->
            <section class="patient-info">
                <h2>Información del Paciente</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Nombre:</span>
                        <span class="value" id="pacienteNombre"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">Edad:</span>
                        <span class="value" id="pacienteEdad"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">Fecha de Consulta:</span>
                        <span class="value" id="fechaConsulta"></span>
                    </div>
                </div>
            </section>

            <!-- Diagnóstico -->
            <section class="diagnosis-section">
                <h2>Diagnóstico</h2>
                <div class="diagnosis-content" id="diagnostico"></div>
            </section>

            <!-- Medicamentos -->
            <section class="medications-section">
                <h2>Prescripción</h2>
                <div id="medicamentosContainer"></div>
            </section>

            <!-- Indicaciones -->
            <section class="indications-section" id="indicacionesSection" style="display: none;">
                <h2>Indicaciones Generales</h2>
                <div class="indications-content" id="indicaciones"></div>
            </section>

            <div class="receta-divider"></div>

            <!-- Footer -->
            <footer class="receta-footer">
                <div class="footer-left">
                    <p><strong>Consultorio:</strong></p>
                    <p>Av.51 #391 x 56 y 58</p>
                    <p>Francisco de Montejo, Mérida, Yucatán</p>
                </div>
                <div class="footer-center">
                    <p><strong>Contacto:</strong></p>
                    <p>Tel: 9992-87-41-61</p>
                    <p>Cel: 981-158-00-36</p>
                    <p>mamg_1793@hotmail.com</p>
                </div>
                <div class="footer-right">
                    <p><strong>Horarios:</strong></p>
                    <p>Lun-Vie: 4:00 PM - 8:00 PM</p>
                    <p>Sáb-Dom: 10:00 AM - 2:00 PM</p>
                    <p>(Previa cita)</p>
                </div>
            </footer>

            <div class="signature-section">
                <div class="signature-line">
                    <p>_________________________________</p>
                    <p><strong>Dr. Manuel Andrés Miranda Guillermo</strong></p>
                    <p>Cédula Profesional: 12159299</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Obtener código de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const codigo = urlParams.get('codigo');

        if (!codigo) {
            showError('No se proporcionó un código de receta');
        } else {
            loadReceta(codigo);
        }

        async function loadReceta(codigo) {
            try {
                const response = await fetch(`/api/recetas/${codigo}`);
                const data = await response.json();

                if (data.success && data.receta) {
                    displayReceta(data.receta);
                } else {
                    showError('Receta no encontrada', codigo);
                }
            } catch (error) {
                console.error('Error cargando receta:', error);
                showError('Error al cargar la receta', codigo);
            }
        }

        function displayReceta(receta) {
            // Ocultar loading
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('recetaContainer').style.display = 'block';

            // Llenar información
            document.getElementById('recetaCodigo').textContent = receta.codigo;
            document.getElementById('pacienteNombre').textContent = receta.paciente_nombre;
            document.getElementById('pacienteEdad').textContent = receta.paciente_edad ? `${receta.paciente_edad} años` : 'N/A';
            document.getElementById('fechaConsulta').textContent = formatDate(receta.fecha_consulta);
            document.getElementById('diagnostico').textContent = receta.diagnostico;

            // Medicamentos
            const medicamentosContainer = document.getElementById('medicamentosContainer');
            medicamentosContainer.innerHTML = receta.medicamentos.map((med, index) => `
                <div class="medication-item">
                    <div class="medication-number">${index + 1}</div>
                    <div class="medication-details">
                        <h3>${med.nombre}</h3>
                        <div class="medication-info">
                            <p><strong>Dosis:</strong> ${med.dosis}</p>
                            <p><strong>Frecuencia:</strong> ${med.frecuencia}</p>
                            <p><strong>Duración:</strong> ${med.duracion}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // Indicaciones (si existen)
            if (receta.indicaciones && receta.indicaciones.trim()) {
                document.getElementById('indicacionesSection').style.display = 'block';
                document.getElementById('indicaciones').textContent = receta.indicaciones;
            }

            // Actualizar título
            document.title = `Receta - ${receta.paciente_nombre}`;
        }

        function showError(message, codigo = '') {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
            if (codigo) {
                document.getElementById('errorCode').textContent = `Código: ${codigo}`;
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    </script>
</body>

</html>